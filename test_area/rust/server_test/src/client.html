<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Dorian Gray</title>
<style>
  body { margin:0; overflow:hidden; background:#000; }
  #container { position: relative; width:100vw; height:100vh; }

  /* Frame container */
  .frame {
    position: absolute; /* allows placement anywhere */
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* The image inside frame */
  .frame img {
    display: block;
  }

  /* Text inside the frame */
  .frame .text {
    position: absolute; /* overlay */
    text-align: center;
    color: white; 
    font-weight: bold;
    pointer-events: none; /* so text doesn't block interactions */
  }

  .line {
    position: absolute;
    transition: opacity 0.5s ease;
    opacity: 0;
    text-align: center;
  }
  .visible { opacity: 1; }
</style>
</head>
<body>
  <div id="container"></div>

<script>
function connectWS() {
  const ws = new WebSocket(`ws://${location.host}/ws`);
  ws.onmessage = ev => {
    const msg = JSON.parse(ev.data);

    // If image, wrap in frame container
    if (msg.media && msg.media.kind === 'image') {
      const frame = document.createElement('div');
      frame.className = 'frame';

      // position frame on screen
      frame.style.left = msg.style.position.x || '50%';
      frame.style.top  = msg.style.position.y || '0';
      frame.style.transform = 'translate(-50%, 0)'; // center horizontally

      const img = document.createElement('img');
      img.src = msg.media.url;

      // set image size
      if (msg.media.img_size) {
        img.style.width = msg.media.img_size.width;
        img.style.height = msg.media.img_size.height;
      }

      frame.appendChild(img);

      // create text overlay
      frame.appendChild(img);
      container.appendChild(frame);

      // Wait for the image to load before adding the text
      img.onload = () => {
        const textDiv = document.createElement('div');
        textDiv.className = 'text';
        textDiv.textContent = msg.text;
        if (msg.style) {
          textDiv.style.color = msg.style.color;
          textDiv.style.fontSize = msg.style.font_size;
          textDiv.style.fontFamily = msg.style.font_family;
        }
        frame.appendChild(textDiv);
      };

      // remove after duration
      setTimeout(() => frame.remove(), msg.media.duration_ms || 5000);
    } else {
      // fallback: normal text without frame
      const div = document.createElement('div');
      div.className = 'line visible';
      div.textContent = msg.speaker ? `${msg.speaker}: ${msg.text}` : msg.text;
      if (msg.style) {
        div.style.color = msg.style.color;
        div.style.fontSize = msg.style.font_size;
        div.style.fontFamily = msg.style.font_family;
        div.style.left = msg.style.position.x || "50%";
        div.style.top = msg.style.position.y || "0";
        div.style.transform = "translateX(-50%)";
      }
      container.appendChild(div);
      setTimeout(() => div.classList.remove('visible'), msg.media?.duration_ms || 5000);
    }
  };

  ws.onclose = () => setTimeout(connectWS, 100);
  ws.onerror = () => ws.close();
}

connectWS();
</script>
</body>
</html>
